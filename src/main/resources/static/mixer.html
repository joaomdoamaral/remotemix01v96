<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mixer AUX</title>
  <style>
    body { margin: 0; background: #111; color: #fff; font-family: sans-serif; overflow: hidden; }
    .mixer-wrapper { display: flex; height: 100vh; overflow: hidden; }
    .mixer-scroll, .hr-divisor {
      display: flex; overflow-x: auto; overflow-y: hidden;
      flex-grow: 1; padding: 3px 0 40px 0;
    }
    #hrDivisor { width: 40px; }
    .mixer-fixed {
      width: 80px; padding: 0 20px 40px 8px;
      border-left: 2px solid #444;
      background: #4f4f4ff5;
      display: flex; flex-direction: row;
    }
    .fader {
      flex: 0 0 80px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: space-between;
      margin: 0 4px; background: #1a1a1a;
      border: 1px solid #333; border-radius: 5px;
    }
    .fader-label {
      height: 65px; width: 100%; font-size: 12px;
      text-align: center; background: #e0e0e0; color: #000;
      display: flex; flex-direction: column; border-top: 1px solid #aaa;
      padding: 2px; box-sizing: border-box;
    }
    .aux-icon-master { font-size: 24px !important; }
    .label-icon { font-size: 20px; margin-bottom: 0px; }
    .label-icon-master { margin-bottom: -3px; }
    .fader-track {
      position: relative; width: 40px;
      height: calc(100dvh - 90px);
      background: #333; border-radius: 10px;
      margin: 10px 0; display: flex; align-items: flex-end;
      overflow: hidden; touch-action: none;
    }
    .fader-fill {
      width: 100%; height: 50%;
      border-radius: 10px 10px 0 0;
      transition: height 0.1s ease-in-out;
    }
    .dB-labels {
      position: absolute; left: 45px; top: 0;
      height: 100%; display: flex;
      flex-direction: column; justify-content: space-between;
      font-size: 10px; color: #aaa;
    }
    .ws-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ffa500;
      z-index: 9999;
    }
  </style>
</head>
<body>

<div class="ws-indicator" id="wsIndicator"></div>

<div class="mixer-wrapper">
  <div class="mixer-scroll" id="mixer"></div>
  <div class="hr-divisor" id="hrDivisor"></div>
  <div class="mixer-fixed" id="master"></div>
</div>

<script>
  const mixer = document.getElementById("mixer");
  const master = document.getElementById("master");
  const wsIndicator = document.getElementById("wsIndicator");

  const urlParams = new URLSearchParams(window.location.search);
  const auxId = urlParams.get('aux');
  const auxLabel = urlParams.get('label');
  const auxIcon = urlParams.get('icon');

  const channels = Array.from({ length: 24 }, (_, i) => ({
    id: i + 1,
    name: `Instrumento ${i + 1}`,
    color: "#5ba2ff",
    icon: "üé§"
  }));

  const masterChannel = {
    id: "M",
    name: "Master",
    color: "#f00",
    icon: "üéöÔ∏è"
  };

  const fadersByChannel = {};

  function createFader({ id, name, color, icon }, parentElement) {
    const isImage = icon.endsWith('.png');
    const iconClass = id === "M" ? "aux-icon-master" : "aux-icon";
    icon = isImage
            ? `<img src="${icon}" alt="${name}" class="${iconClass}" style="width: 26px; height: 26px;">`
            : `<span class="${iconClass}">${icon}</span>`;

    const fader = document.createElement("div");
    fader.className = "fader";

    const track = document.createElement("div");
    track.className = "fader-track";

    const fill = document.createElement("div");
    fill.className = "fader-fill";
    fill.style.background = color;
    fill.style.height = "40%";
    track.appendChild(fill);

    const dBMarks = document.createElement("div");
    dBMarks.className = "dB-labels";
    dBMarks.innerHTML = "<div>-‚àû</div><div>-30</div><div>-15</div><div>0</div><div>+6</div>";
    track.appendChild(dBMarks);

    let currentValue = 64;

    const updateFill = (value) => {
      currentValue = Math.max(0, Math.min(127, value));
      const percent = (currentValue / 127) * 100;
      fill.style.height = percent + "%";
    };

    const handleMove = (e) => {
      const rect = track.getBoundingClientRect();
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const offsetY = clientY - rect.top;
      const percent = Math.max(0, Math.min(1, 1 - offsetY / rect.height));
      const value = Math.round(percent * 127);
      updateFill(value);
      sendVolumeToMixer(id, value);
    };

    const startMove = (e) => {
      e.preventDefault();
      handleMove(e);
      document.addEventListener("mousemove", handleMove);
      document.addEventListener("mouseup", stopMove);
      document.addEventListener("touchmove", handleMove);
      document.addEventListener("touchend", stopMove);
    };

    const stopMove = () => {
      document.removeEventListener("mousemove", handleMove);
      document.removeEventListener("mouseup", stopMove);
      document.removeEventListener("touchmove", handleMove);
      document.removeEventListener("touchend", stopMove);
    };

    track.addEventListener("mousedown", startMove);
    track.addEventListener("touchstart", startMove);
    fader.appendChild(track);

    const label = document.createElement("div");
    label.className = "fader-label";
    label.innerHTML = `
      <div class="label-icon${id === "M" ? "-master" : ""}">
        <span id="${id === "M" ? "label-master" : "chNumber-label"}">${id === "M" ? "AUX " + auxId : id}</span> ${icon}
      </div>`;
    if (id === "M") {
      label.className += " div-label-master";
      label.innerHTML += `<div class="masterLabel">${auxLabel}</div>`;
    } else {
      label.innerHTML += `<div>${name}</div>`;
    }
    fader.appendChild(label);
    parentElement.appendChild(fader);

    return { fader, update: updateFill };
  }

  channels.forEach((ch) => {
    fadersByChannel[String(ch.id)] = createFader(ch, mixer);
  });

  if (auxIcon) masterChannel.icon = auxIcon;
  fadersByChannel["M"] = createFader(masterChannel, master);

  function sendVolumeToMixer(channelId, volume) {
    const percentual = Math.round((volume / 127) * 100);
    const payload = {
      auxNumber: parseInt(auxId),
      inputChannel: channelId === 'M' ? 0 : parseInt(channelId),
      faderLevel: percentual
    };

    if (socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify(payload));
    }

    fetch(`/api/midi/volume?auxNumber=${payload.auxNumber}&inputChannel=${payload.inputChannel}&faderLevel=${payload.faderLevel}`, {
      method: "POST"
    });
  }

  const socket = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws/midi");

  socket.onopen = () => wsIndicator.style.background = "#0f0";
  socket.onclose = () => wsIndicator.style.background = "#f33";
  socket.onerror = () => wsIndicator.style.background = "#ffa500";

  function canalParaIdFader(canal) {
    return canal === 0 ? "M" : String(canal);
  }

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log("[WS] Mensagem recebida:", data);

    const fader = fadersByChannel[canalParaIdFader(data.canal)];
    if (fader) {
      const valor = Math.round((data.valor / 100) * 127);
      fader.update(valor);
    } else {
      console.warn("‚ö†Ô∏è Fader n√£o encontrado para canal:", data.canal);
    }
  };

  let syncInterval = null;

  function iniciarSincronizacaoAutomatica(aux) {
    pararSincronizacao();
    syncInterval = setInterval(() => {
      fetch(`/api/midi/sincronizar?aux=${aux}`, { method: "POST" })
              .then(() => console.log(`[SYNC] Solicitado AUX ${aux}`))
              .catch((err) => console.error("[SYNC] Falha:", err));
    }, 10000);
  }

  function pararSincronizacao() {
    if (syncInterval) {
      clearInterval(syncInterval);
      syncInterval = null;
    }
  }

  if (auxId) iniciarSincronizacaoAutomatica(auxId);
  window.addEventListener("beforeunload", pararSincronizacao);
</script>
</body>
</html>
